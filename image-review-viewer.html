<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>리뷰 이미지 뷰어</title>
  <link rel="icon" href="favicon.png" type="image/png">

  <!-- 로컬 SheetJS가 있으면 사용(읽기용). 없으면 CSV/TSV 파서로 폴백 -->
  <script src="./xlsx.full.min.js"></script>
  <script>
    setTimeout(() => {
      if (!window.XLSX) {
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js";
        s.onerror = function () {
          const s2 = document.createElement('script');
          s2.src = "https://unpkg.com/xlsx@0.20.3/dist/xlsx.full.min.js";
          document.head.appendChild(s2);
        };
        document.head.appendChild(s);
      }
    }, 200);
  </script>

  <style>
    :root {
      --bg: #0b0c10;
      --fg: #e6e6e6;
      --card: #111319;
      --line: #1f2833;
      --mut: #aab0bd;
      --accent: #0ea5e9
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Pretendard, Apple SD Gothic Neo, Malgun Gothic, sans-serif
    }

    header {
      position: sticky;
      top: 0;
      background: var(--bg);
      border-bottom: 1px solid var(--line);
      padding: 14px 16px;
      z-index: 10
    }

    h1 {
      margin: 0;
      font-size: 18px
    }

    main {
      max-width: 1200px;
      margin: 18px auto;
      padding: 0 12px 120px
    }

    .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items: center;
      margin-bottom: 10px
    }

    .btn {
      background: var(--accent);
      color: #001018;
      border: none;
      border-radius: 10px;
      padding: 9px 12px;
      font-weight: 600;
      cursor: pointer
    }

    .btn.secondary {
      background: #202633;
      color: var(--fg);
      border: 1px solid var(--line)
    }

    .btn.ghost {
      background: transparent;
      border: 1px dashed var(--line);
      color: var(--fg)
    }

    .btn.small {
      padding: 6px 10px;
      font-size: 12px
    }

    .btn:disabled {
      opacity: .5;
      cursor: not-allowed
    }

    .filelabel {
      border: 1px dashed var(--line);
      padding: 9px 12px;
      border-radius: 10px;
      cursor: pointer
    }

    input[type=file] {
      display: none
    }

    select,
    .input {
      background: #0f131b;
      color: var(--fg);
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: 8px
    }

    .hint {
      opacity: .8;
      font-size: 12px
    }

    .filters {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin: 6px 0 10px
    }

    .filters .small {
      font-size: 12px;
      color: var(--mut)
    }

    /* 열 8개: 리뷰아이디 / 전화번호 / 번호자리수 / 이미지 / 이미지개수 / 전화번호체크 / 체크 / 비고 */
    .grid-head,
    .row {
      display: grid;
      grid-template-columns: 180px 160px 90px 170px 90px 130px 110px 110px;
      gap: 12px
    }

    .grid-head {
      color: var(--mut);
      font-size: 12px;
      margin: 6px 0
    }

    .row {
      align-items: center;
      border-top: 1px solid var(--line);
      padding: 10px 0
    }

    .row:first-child {
      border-top: none
    }

    .imgbox {
      width: 150px;
      height: 150px;
      border: 1px dashed var(--line);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      background: #0f1117;
      margin: 0 auto
    }

    .imgbox img {
      width: 100%;
      height: 100%;
      object-fit: cover
    }

    .status {
      font-size: 12px;
      opacity: .85;
      text-align: center;
      margin-top: 6px
    }

    .small {
      font-size: 12px;
      opacity: .85
    }

    .good {
      color: #86efac
    }

    .bad {
      color: #fca5a5
    }

    .phone {
      font-family: ui-monospace, Consolas, Menlo, monospace
    }

    .empty {
      opacity: .75;
      font-style: italic;
      padding: 16px;
      text-align: center
    }

    .sticky {
      position: fixed;
      right: 16px;
      bottom: 16px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .drop {
      margin-top: 8px;
      border: 1px dashed var(--line);
      border-radius: 12px;
      padding: 14px;
      text-align: center;
      opacity: .9
    }

    .drop.drag {
      outline: 2px solid var(--accent);
      outline-offset: 3px
    }

    .count {
      margin-left: auto;
      color: var(--mut);
      font-size: 12px
    }

    .pagination {
      display: flex;
      gap: 8px;
      align-items: center;
      justify-content: flex-end;
      margin-top: 12px;
      flex-wrap: wrap
    }

    .page-info {
      font-size: 12px;
      color: var(--mut);
      margin-left: auto
    }

    .number-input {
      width: 90px
    }

    .page-numbers {
      display: flex;
      gap: 6px;
      align-items: center
    }

    .page-btn {
      background: #202633;
      color: var(--fg);
      border: 1px solid var(--line);
      border-radius: 8px;
      padding: 6px 10px;
      font-size: 12px;
      cursor: pointer
    }

    .page-btn[disabled] {
      opacity: .6;
      cursor: not-allowed
    }

    .page-btn.active {
      background: #0ea5e9;
      color: #001018;
      border-color: #0ea5e9;
      font-weight: 700
    }

    .center {
      text-align: center
    }
  </style>
</head>

<body>
  <header>
    <h1>리뷰 이미지 뷰어</h1>
    <nav style="margin-top:6px;">
      <a href="index.html" style="color:var(--accent);text-decoration:none;font-size:14px;">단어 추출 사이트로 가기</a><br>
      <a href="discount.html" style="color:var(--accent);text-decoration:none;font-size:14px;">캐시백 조회 사이트로 가기</a>
    </nav>
  </header>
  <main>
    <div class="card">
      <div class="toolbar">
        <label class="filelabel" for="fileInput">CSV 업로드</label>
        <input id="fileInput" type="file" accept=".xlsx,.xls,.xlsm,.csv,.tsv,.txt" />
        <select id="sheetSelect" title="시트 선택" disabled></select>
        <button id="downloadAll" class="btn" disabled>CSV 내보내기(전체)</button>
        <button id="downloadFiltered" class="btn secondary" disabled>CSV 내보내기(필터 결과)</button>
        <button id="clearBtn" class="btn ghost" disabled>초기화</button>
        <span class="hint">형식: A=리뷰아이디, B=전화번호, C=이미지URL(쉼표 가능)</span>
      </div>

      <div class="filters">
        <input id="searchInput" class="input" placeholder="검색: 리뷰아이디/전화번호" />
        <select id="statusFilter" title="상태">
          <option value="all">상태: 전체</option>
          <option value="ok">이미지 로드 성공</option>
          <option value="fail">이미지 로드 실패/URL없음</option>
        </select>

        <!-- 이미지개수 범위 필터 -->
        <label class="small" style="display:flex;align-items:center;gap:6px">
          이미지개수
          <input id="minCount" type="number" class="input number-input" min="0" placeholder="최소" />
          ~
          <input id="maxCount" type="number" class="input number-input" min="0" placeholder="최대" />
        </label>

        <!-- 하나라도 체크된 항목만 -->
        <label class="small"><input type="checkbox" id="anyCheckedOnly" /> 하나라도 체크된 항목만</label>

        <div class="master">
          <button id="uncheckAll" class="btn secondary" type="button">체크 전체 해제</button>
        </div>

        <label class="small" style="display:flex;align-items:center;gap:6px;margin-left:auto">
          페이지당
          <input id="pageSizeInput" type="number" class="input number-input" min="1" value="20" />
          건
        </label>

        <div class="count" id="countInfo">0 / 0</div>
      </div>

      <div id="drop" class="drop small">여기에 파일을 직접 드래그&드롭해도 됩니다.</div>

      <div class="grid-head">
        <div>리뷰아이디</div>
        <div>전화번호</div>
        <div class="center">번호자리수</div>
        <div>이미지 (150×150)</div>
        <div class="center">이미지개수</div>
        <div>전화번호체크</div>
        <div>체크</div>
        <div>비고</div>
      </div>
      <div id="list"></div>
      <div id="empty" class="empty">CSV를 업로드하면 세로 목록으로 표시됩니다.</div>

      <div class="pagination">
        <button id="firstBtn" class="btn small" disabled>&laquo; 처음</button>
        <button id="prevBtn" class="btn small" disabled>&lsaquo; 이전</button>
        <div id="pageNumbers" class="page-numbers"></div>
        <span class="page-info" id="pageInfo">페이지 0 / 0</span>
        <label class="small" style="display:flex;align-items:center;gap:6px">
          이동
          <input id="pageJump" type="number" class="input number-input" min="1" value="1" />
          페이지
        </label>
        <button id="nextBtn" class="btn small" disabled>다음 &rsaquo;</button>
        <button id="lastBtn" class="btn small" disabled>끝 &raquo;</button>
      </div>
    </div>
  </main>

  <div class="sticky">
    <button id="downloadAll2" class="btn" disabled>CSV(전체)</button>
    <button id="downloadFiltered2" class="btn secondary" disabled>CSV(필터)</button>
  </div>

  <script>
    const S = {
      fileInput: document.getElementById('fileInput'),
      sheetSelect: document.getElementById('sheetSelect'),
      list: document.getElementById('list'),
      empty: document.getElementById('empty'),
      dlAll: document.getElementById('downloadAll'),
      dlAll2: document.getElementById('downloadAll2'),
      dlFiltered: document.getElementById('downloadFiltered'),
      dlFiltered2: document.getElementById('downloadFiltered2'),
      clear: document.getElementById('clearBtn'),
      drop: document.getElementById('drop'),
      search: document.getElementById('searchInput'),
      status: document.getElementById('statusFilter'),
      anyCheckedOnly: document.getElementById('anyCheckedOnly'),
      count: document.getElementById('countInfo'),
      uncheckAll: document.getElementById('uncheckAll'),
      pageSizeInput: document.getElementById('pageSizeInput'),
      pageInfo: document.getElementById('pageInfo'),
      pageJump: document.getElementById('pageJump'),
      firstBtn: document.getElementById('firstBtn'),
      prevBtn: document.getElementById('prevBtn'),
      nextBtn: document.getElementById('nextBtn'),
      lastBtn: document.getElementById('lastBtn'),
      pageNumbers: document.getElementById('pageNumbers'),
      minCount: document.getElementById('minCount'),
      maxCount: document.getElementById('maxCount'),
    };
    let wb = null;
    let rows = [];
    let lastFileName = '';

    const state = { currentPage: 1, pageSize: 20 };

    function showEmpty(state) { S.empty.style.display = state ? 'block' : 'none'; }
    function setControlsEnabled(hasData) {
      [S.dlAll, S.dlAll2, S.dlFiltered, S.dlFiltered2, S.clear].forEach(b => b.disabled = !hasData);
      S.sheetSelect.disabled = !wb;
      S.uncheckAll.disabled = !hasData;
      [S.firstBtn, S.prevBtn, S.nextBtn, S.lastBtn, S.pageJump, S.pageSizeInput, S.minCount, S.maxCount].forEach(el => el.disabled = !hasData);
    }

    /* 유틸 */
    function stripQuotes(s) {
      if (s == null) return s;
      const t = String(s).trim();
      if ((t.startsWith('"') && t.endsWith('"')) || (t.startsWith("'") && t.endsWith("'"))) return t.slice(1, -1);
      return t;
    }
    function normalizeUrl(u) {
      if (!u) return null;
      let s = u.trim();
      s = s.replace(/^(https?):\/(?!\/)/i, '$1://'); // https:/ → https:// 보정
      return s;
    }
    function splitUrls(raw) {
      if (!raw) return [];
      return String(raw).split(',')
        .map(x => stripQuotes(x).trim())
        .filter(Boolean)
        .map(normalizeUrl);
    }
    function deriveFilename(url) {
      try {
        const u = new URL(url);
        const p = u.pathname.split('/').filter(Boolean);
        if (!p.length) return null;
        return decodeURIComponent(p[p.length - 1]);
      } catch {
        if (typeof url === 'string') {
          const parts = url.split('?')[0].split('#')[0].split('/');
          return parts.length ? decodeURIComponent(parts[parts.length - 1] || '') || null : null;
        }
        return null;
      }
    }
    function digitsOnly(v) { return (v || '').toString().replace(/\D+/g, ''); }
    function isPhoneValid(v) { return digitsOnly(v).length === 11; }
    function scrollToTop() { window.scrollTo({ top: 0, behavior: 'smooth' }); }

    /* 파싱 (A:리뷰아이디, B:전화번호, C:이미지URL[,]) + 비고 자동체크(5~6개) */
    function parseAoA(aoa) {
      if (!aoa || !aoa.length) return [];
      const first = aoa[0].map(v => String(v ?? '').toLowerCase());
      let start = 0;
      const isHeader = first.some(v => v.includes('리뷰') || v.includes('review')) ||
        first.some(v => v.includes('이미지') || v.includes('image') || v.includes('url')) ||
        first.some(v => v.includes('전화') || v.includes('phone'));
      if (isHeader) start = 1;

      const out = [];
      for (let i = start; i < aoa.length; i++) {
        const r = aoa[i] || [];
        const reviewId = (r[0] ?? '').toString().trim();
        const phoneRaw = (r[1] ?? '').toString().trim();
        const imageRaw = (r[2] ?? '').toString().trim();
        if (!reviewId && !imageRaw && !phoneRaw) continue;

        const urls = splitUrls(imageRaw);
        const firstUrl = urls[0] || null;
        const imageCount = urls.length;
        const filename = firstUrl ? deriveFilename(firstUrl) : null;

        const phoneFlag = !isPhoneValid(phoneRaw);                // 11자리 숫자 아니면 자동 체크
        const remarkAuto = (imageCount >= 5 && imageCount <= 6);   // ★ 5~6개면 비고 자동 체크

        out.push({
          reviewId,
          firstUrl,
          imageCount,
          filename,          // CSV/검색용 (UI에는 숨김)
          phone: phoneRaw || '',
          phoneFlag,         // 전화번호체크
          checked: !firstUrl, // 이미지 없으면 자동 체크
          remark: remarkAuto, // ★ 자동 체크
          loadOK: firstUrl ? undefined : false
        });
      }
      return out;
    }

    /* 필터 */
    function applyFilters() {
      const q = S.search.value.trim().toLowerCase();
      const st = S.status.value; // all/ok/fail
      const anyOnly = S.anyCheckedOnly.checked;

      // 이미지개수 범위 읽기
      let minC = parseInt(S.minCount.value, 10);
      let maxC = parseInt(S.maxCount.value, 10);
      const hasMin = !isNaN(minC);
      const hasMax = !isNaN(maxC);
      if (hasMin && hasMax && minC > maxC) { const t = minC; minC = maxC; maxC = t; } // 스왑

      let arr = rows.slice();

      if (q) {
        arr = arr.filter(r => {
          const a = (r.reviewId || '').toLowerCase();
          const p = (r.phone || '').toLowerCase();
          const f = (r.filename || '').toLowerCase(); // 파일명은 UI엔 없지만 검색/CSV에는 유지
          return a.includes(q) || p.includes(q) || f.includes(q);
        });
      }
      if (st === 'ok') arr = arr.filter(r => r.loadOK === true);
      else if (st === 'fail') arr = arr.filter(r => r.loadOK === false);

      if (hasMin) arr = arr.filter(r => (r.imageCount ?? 0) >= minC);
      if (hasMax) arr = arr.filter(r => (r.imageCount ?? 0) <= maxC);

      if (anyOnly) arr = arr.filter(r => !!(r.checked || r.remark || r.phoneFlag));

      return arr;
    }

    /* 렌더 + 페이지네이션 */
    function getPaged(arr) {
      const total = arr.length;
      const pages = Math.max(1, Math.ceil(total / Math.max(1, state.pageSize)));
      if (state.currentPage > pages) state.currentPage = pages;
      const start = (state.currentPage - 1) * state.pageSize;
      const subset = arr.slice(start, start + state.pageSize);
      return { subset, total, pages, start };
    }

    function updatePaginationUI(totalFiltered, pages) {
      S.pageInfo.textContent = `페이지 ${state.currentPage} / ${pages}`;
      S.pageJump.min = 1;
      S.pageJump.max = pages;
      S.pageJump.value = state.currentPage;
      S.firstBtn.disabled = state.currentPage <= 1;
      S.prevBtn.disabled = state.currentPage <= 1;
      S.nextBtn.disabled = state.currentPage >= pages;
      S.lastBtn.disabled = state.currentPage >= pages;
      renderPageButtons(pages);
    }

    function renderPageButtons(pages) {
      const maxBtns = 5; // ★ 한 번에 5개
      let start = Math.max(1, state.currentPage - Math.floor(maxBtns / 2));
      let end = start + maxBtns - 1;
      if (end > pages) { end = pages; start = Math.max(1, end - maxBtns + 1); }

      S.pageNumbers.innerHTML = '';
      for (let i = start; i <= end; i++) {
        const b = document.createElement('button');
        b.className = 'page-btn';
        b.textContent = i;
        if (i === state.currentPage) {
          b.classList.add('active');
          b.disabled = true;
          b.setAttribute('aria-current', 'page');
        }
        b.addEventListener('click', () => setPage(i, true));
        S.pageNumbers.appendChild(b);
      }
    }

    function render() {
      const filtered = applyFilters();
      const { subset, total, pages } = getPaged(filtered);

      S.list.innerHTML = '';
      if (!rows.length) { showEmpty(true); setControlsEnabled(false); S.count.textContent = '0 / 0'; updatePaginationUI(0, 1); return; }
      showEmpty(false); setControlsEnabled(true);

      subset.forEach(r => S.list.appendChild(rowElement(r)));

      S.count.textContent = `현재 ${subset.length}건 · 필터 ${total} / 전체 ${rows.length}`;
      updatePaginationUI(total, pages);
    }

    function rowElement(r) {
      const row = document.createElement('div');
      row.className = 'row';

      // 1) 리뷰아이디
      const c1 = document.createElement('div'); c1.textContent = r.reviewId ?? ''; row.appendChild(c1);

      // 2) 전화번호
      const c2 = document.createElement('div');
      const phoneText = document.createElement('div');
      phoneText.className = 'phone';
      phoneText.textContent = r.phone ? r.phone : '-';
      c2.appendChild(phoneText);
      row.appendChild(c2);

      // 3) 번호자리수 (숫자만 카운트)
      const c3 = document.createElement('div');
      c3.className = 'center';
      const digitsLen = (r.phone ? (r.phone.toString().match(/\d/g) || []).length : 0);
      c3.textContent = digitsLen;
      row.appendChild(c3);

      // 4) 이미지 + 상태 텍스트
      const c4 = document.createElement('div');
      const box = document.createElement('div'); box.className = 'imgbox';
      const st = document.createElement('div'); st.className = 'status';
      if (r.firstUrl) {
        const img = document.createElement('img');
        img.loading = 'lazy'; img.decoding = 'async'; img.src = r.firstUrl; img.width = 150; img.height = 150;
        img.onload = () => { r.loadOK = true; st.textContent = '이미지 로드 성공'; st.classList.remove('bad'); st.classList.add('good'); };
        img.onerror = () => {
          r.loadOK = false; r.checked = true;
          st.textContent = '이미지 로드 실패 (내보내기: null)';
          st.classList.remove('good'); st.classList.add('bad');
          box.innerHTML = '<span class="small">로드 실패</span>';
        };
        box.appendChild(img);
      } else {
        r.loadOK = false; r.checked = true;
        st.textContent = 'URL 없음 (내보내기: null)';
        st.classList.add('bad');
        box.innerHTML = '<span class="small">URL 없음</span>';
      }
      c4.appendChild(box);
      c4.appendChild(st);
      row.appendChild(c4);

      // 5) 이미지 개수
      const c5 = document.createElement('div');
      c5.className = 'center';
      c5.textContent = typeof r.imageCount === 'number' ? r.imageCount : '0';
      row.appendChild(c5);

      // 6) 전화번호 체크
      const c6 = document.createElement('div');
      const cbPhone = document.createElement('input'); cbPhone.type = 'checkbox'; cbPhone.checked = !!r.phoneFlag;
      cbPhone.title = r.phone ? `전화: ${r.phone}` : '전화번호 없음';
      cbPhone.addEventListener('change', () => { r.phoneFlag = cbPhone.checked; });
      c6.appendChild(cbPhone); row.appendChild(c6);

      // 7) 체크
      const c7 = document.createElement('div');
      const cb = document.createElement('input'); cb.type = 'checkbox'; cb.checked = !!r.checked;
      cb.addEventListener('change', () => { r.checked = cb.checked; });
      c7.appendChild(cb); row.appendChild(c7);

      // 8) 비고
      const c8 = document.createElement('div');
      const cb2 = document.createElement('input'); cb2.type = 'checkbox'; cb2.checked = !!r.remark;
      cb2.addEventListener('change', () => { r.remark = cb2.checked; });
      c8.appendChild(cb2); row.appendChild(c8);

      return row;
    }

    /* 페이지 변경(Top 스크롤) */
    function setPage(n, doScroll) {
      const pages = Math.max(1, Math.ceil(applyFilters().length / Math.max(1, state.pageSize)));
      state.currentPage = Math.min(Math.max(1, n), pages);
      render();
      if (doScroll) scrollToTop();
    }

    /* 체크 전체 해제 */
    function setCheckedFor(arr, val) {
      arr.forEach(r => r.checked = !!val);
      render();
    }
    S.uncheckAll?.addEventListener('click', () => setCheckedFor(rows, false));

    /* CSV 내보내기 (BOM 포함, IE/Edge 레거시 대응) */
    function saveCSV(arr, filenameTag) {
      const out = [['리뷰아이디', '파일명', '이미지', '이미지개수', '체크', '전화번호', '전화번호체크', '비고']];
      arr.forEach(r => {
        const imgCell = (r.loadOK === false) ? null : (r.firstUrl || null);
        const cnt = (typeof r.imageCount === 'number') ? r.imageCount : 0;
        const chk = r.checked ? 'x' : '';
        const phone = r.phone || '';
        const phoneChk = r.phoneFlag ? 'x' : '';
        const remark = r.remark ? 'x' : '';
        out.push([r.reviewId || '', r.filename || null, imgCell, cnt, chk, phone, phoneChk, remark]);
      });

      const csv = out.map(row => row.map(v => {
        if (v === null || v === undefined) return '';
        const s = String(v).replace(/"/g, '""');
        return /[",\n]/.test(s) ? `"${s}"` : s;
      }).join(',')).join('\n');

      const csvWithBom = '\uFEFF' + csv;
      const blob = new Blob([csvWithBom], { type: 'text/csv;charset=utf-8' });

      const t = new Date();
      const tag = `${t.getFullYear()}${String(t.getMonth() + 1).padStart(2, '0')}${String(t.getDate()).padStart(2, '0')}_${String(t.getHours()).padStart(2, '0')}${String(t.getMinutes()).padStart(2, '0')}${String(t.getSeconds()).padStart(2, '0')}`;
      const fname = `${(lastFileName || 'review')}_${filenameTag}_${tag}.csv`;

      if (window.navigator && window.navigator.msSaveOrOpenBlob) {
        window.navigator.msSaveOrOpenBlob(blob, fname);
        return;
      }
      const a = document.createElement('a');
      a.style.display = 'none';
      a.href = URL.createObjectURL(blob);
      a.download = fname;
      document.body.appendChild(a);
      a.click();
      setTimeout(() => { URL.revokeObjectURL(a.href); a.remove(); }, 0);
    }

    /* CSV/TSV 파서 (따옴표·이스케이프 처리) */
    function parseDelimited(text, delimiter) {
      const rows = [];
      let row = [], cell = '', inQuotes = false;
      for (let i = 0; i < text.length; i++) {
        const ch = text[i];
        if (ch === '"') {
          if (inQuotes && text[i + 1] === '"') { cell += '"'; i++; }
          else inQuotes = !inQuotes;
        } else if (ch === delimiter && !inQuotes) {
          row.push(cell); cell = '';
        } else if ((ch === '\n' || ch === '\r') && !inQuotes) {
          if (ch === '\r' && text[i + 1] === '\n') i++; // CRLF
          row.push(cell); rows.push(row); row = []; cell = '';
        } else {
          cell += ch;
        }
      }
      row.push(cell);
      if (row.length > 1 || row[0] !== '') rows.push(row);
      return rows.map(r => r.map(c => stripQuotes(c)));
    }

    /* 워크북/파일 로드 */
    function handleWorkbookLoaded() {
      S.sheetSelect.innerHTML = '';
      wb.SheetNames.forEach((n, i) => {
        const opt = document.createElement('option');
        opt.value = n; opt.textContent = `${i + 1}. ${n}`;
        S.sheetSelect.appendChild(opt);
      });
      S.sheetSelect.disabled = false;
      loadSheet(wb.SheetNames[0]);
    }

    function loadSheet(name) {
      try {
        const ws = wb.Sheets[name];
        const aoa = XLSX.utils.sheet_to_json(ws, { header: 1, raw: true, defval: '' });
        rows = parseAoA(aoa);
        state.currentPage = 1;
        render();
      } catch (e) {
        console.warn(`시트 "${name}" 파싱 중 오류`, e);
        rows = []; render();
      }
    }

    function tryReadAsExcelOrCsv(file, buf) {
      try {
        if (!window.XLSX) throw new Error('XLSX 라이브러리가 로드되지 않았습니다(CDN 차단/로컬 파일 부재).');
        wb = XLSX.read(buf, { type: 'array' });
        handleWorkbookLoaded();
        return;
      } catch (e) {
        console.warn('XLSX 파싱 실패 → CSV/TSV 파서로 시도', e);
      }

      const text = new TextDecoder('utf-8').decode(buf);
      const hasTab = text.indexOf('\t') !== -1;
      const delim = hasTab ? '\t' : ',';
      const aoa = parseDelimited(text, delim);
      rows = parseAoA(aoa);
      wb = null;
      S.sheetSelect.innerHTML = ''; S.sheetSelect.disabled = true;
      state.currentPage = 1;
      render();
    }

    function onFile(file) {
      lastFileName = (file?.name || '').replace(/\.(xlsx|xls|xlsm|csv|tsv|txt)$/i, '');
      const r = new FileReader();
      r.onload = (ev) => {
        const buf = new Uint8Array(ev.target.result);
        tryReadAsExcelOrCsv(file, buf);
      };
      r.onerror = (e) => console.error('파일 읽기 실패', e);
      r.readAsArrayBuffer(file);
    }

    /* 드래그&드롭 안정화: 전역 기본 동작 차단 + 전파 중지 */
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(evt => {
      document.addEventListener(evt, e => { e.preventDefault(); e.stopPropagation(); }, false);
    });
    S.drop.addEventListener('dragenter', e => { e.preventDefault(); e.stopPropagation(); S.drop.classList.add('drag'); });
    S.drop.addEventListener('dragover', e => { e.preventDefault(); e.stopPropagation(); S.drop.classList.add('drag'); });
    S.drop.addEventListener('dragleave', e => { e.preventDefault(); e.stopPropagation(); S.drop.classList.remove('drag'); });
    S.drop.addEventListener('drop', e => {
      e.preventDefault(); e.stopPropagation(); S.drop.classList.remove('drag');
      const f = e.dataTransfer?.files?.[0];
      if (!f) return;
      onFile(f);
    });

    /* 기타 이벤트 */
    S.fileInput.addEventListener('change', e => {
      const f = e.target.files?.[0];
      if (!f) return; onFile(f);
    });
    S.sheetSelect.addEventListener('change', e => loadSheet(e.target.value));

    // 필터 변경 → 1페이지 + 상단 (이미지개수 포함)
    [S.search, S.status, S.anyCheckedOnly, S.minCount, S.maxCount].forEach(el =>
      el.addEventListener('input', () => setPage(1, true))
    );

    // 페이지 사이즈 변경 → 1페이지 + 상단
    S.pageSizeInput.addEventListener('change', () => {
      const v = parseInt(S.pageSizeInput.value, 10);
      state.pageSize = Math.max(1, isNaN(v) ? 20 : v);
      setPage(1, true);
    });

    // 페이지 이동(Top 자동)
    S.firstBtn.addEventListener('click', () => setPage(1, true));
    S.prevBtn.addEventListener('click', () => setPage(state.currentPage - 1, true));
    S.nextBtn.addEventListener('click', () => setPage(state.currentPage + 1, true));
    S.lastBtn.addEventListener('click', () => {
      const pages = Math.max(1, Math.ceil(applyFilters().length / Math.max(1, state.pageSize)));
      setPage(pages, true);
    });
    S.pageJump.addEventListener('change', () => {
      const pages = Math.max(1, Math.ceil(applyFilters().length / Math.max(1, state.pageSize)));
      let v = parseInt(S.pageJump.value, 10);
      if (isNaN(v)) v = state.currentPage;
      v = Math.min(Math.max(1, v), pages);
      setPage(v, true);
    });

    /* CSV 버튼 연결 (메인 + 우측 하단) */
    S.dlAll.addEventListener('click', () => saveCSV(rows, 'all'));
    S.dlAll2.addEventListener('click', () => saveCSV(rows, 'all'));
    S.dlFiltered.addEventListener('click', () => saveCSV(applyFilters(), 'filtered'));
    S.dlFiltered2.addEventListener('click', () => saveCSV(applyFilters(), 'filtered'));

    /* 초기화 */
    S.clear.addEventListener('click', () => {
      wb = null; rows = []; lastFileName = '';
      S.sheetSelect.innerHTML = ''; S.sheetSelect.disabled = true;
      state.currentPage = 1;
      render();
    });

    /* 초기 상태 */
    showEmpty(true); setControlsEnabled(false);
  </script>
</body>

</html>