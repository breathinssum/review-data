<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>리뷰 이미지 뷰어</title>

<!-- 로컬 SheetJS: 엑셀 읽기용(쓰기 아님). 파일과 같은 폴더에 xlsx.full.min.js가 있으면 사용 -->
<script src="./xlsx.full.min.js"></script>
<!-- 실패 시 CDN 백업 (회사망에서 막히면 그냥 CSV만 써도 됨) -->
<script>
  setTimeout(()=>{
    if(!window.XLSX){
      var s=document.createElement('script');
      s.src="https://cdn.jsdelivr.net/npm/xlsx@0.20.3/dist/xlsx.full.min.js";
      s.onerror=function(){
        var s2=document.createElement('script');
        s2.src="https://unpkg.com/xlsx@0.20.3/dist/xlsx.full.min.js";
        document.head.appendChild(s2);
      };
      document.head.appendChild(s);
    }
  }, 200);
</script>

<style>
  :root{--bg:#0b0c10;--fg:#e6e6e6;--card:#111319;--line:#1f2833;--mut:#aab0bd;--accent:#0ea5e9}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--fg);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Pretendard,Apple SD Gothic Neo,Malgun Gothic,sans-serif}
  header{position:sticky;top:0;background:var(--bg);border-bottom:1px solid var(--line);padding:14px 16px;z-index:10}
  h1{margin:0;font-size:18px}
  main{max-width:1200px;margin:18px auto;padding:0 12px 120px}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:14px}
  .toolbar{display:flex;flex-wrap:wrap;gap:10px;align-items:center;margin-bottom:10px}
  .btn{background:var(--accent);color:#001018;border:none;border-radius:10px;padding:9px 12px;font-weight:600;cursor:pointer}
  .btn.secondary{background:#202633;color:var(--fg);border:1px solid var(--line)}
  .btn.ghost{background:transparent;border:1px dashed var(--line);color:var(--fg)}
  .btn.small{padding:6px 10px;font-size:12px}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .filelabel{border:1px dashed var(--line);padding:9px 12px;border-radius:10px;cursor:pointer}
  input[type=file]{display:none}
  select, .input{background:#0f131b;color:var(--fg);border:1px solid var(--line);border-radius:10px;padding:8px}
  .hint{opacity:.8;font-size:12px}
  .filters{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:6px 0 10px}
  .filters .small{font-size:12px;color:var(--mut)}
  .grid-head, .row{display:grid;grid-template-columns:180px 1fr 170px 110px;gap:12px}
  .grid-head{color:var(--mut);font-size:12px;margin:6px 0}
  .row{align-items:center;border-top:1px solid var(--line);padding:10px 0}
  .row:first-child{border-top:none}
  .imgbox{width:150px;height:150px;border:1px dashed var(--line);border-radius:10px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#0f1117}
  .imgbox img{width:100%;height:100%;object-fit:cover}
  .filename{font-family:ui-monospace,Consolas,Menlo,monospace;word-break:break-all}
  .small{font-size:12px;opacity:.85}
  .good{color:#86efac}.bad{color:#fca5a5}
  .empty{opacity:.75;font-style:italic;padding:16px;text-align:center}
  .sticky{position:fixed;right:16px;bottom:16px;display:flex;gap:8px;flex-wrap:wrap}
  .drop{margin-top:8px;border:1px dashed var(--line);border-radius:12px;padding:14px;text-align:center;opacity:.9}
  .drop.drag{outline:2px solid var(--accent);outline-offset:3px}
  .count{margin-left:auto;color:var(--mut);font-size:12px}
  .master{display:flex;gap:6px;align-items:center}

  .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:12px;flex-wrap:wrap}
  .page-info{font-size:12px;color:var(--mut);margin-left:auto}
  .number-input{width:90px}

  .page-numbers{display:flex;gap:6px;align-items:center}
  .page-btn{background:#202633;color:var(--fg);border:1px solid var(--line);border-radius:8px;padding:6px 10px;font-size:12px;cursor:pointer}
  .page-btn[disabled]{opacity:.6;cursor:not-allowed}
  .page-btn.active{background:var(--accent);color:#001018;border-color:var(--accent);font-weight:700}
</style>
</head>
<body>
<header>
  <h1>리뷰 이미지 뷰어</h1>
  <nav style="margin-top:6px;">
    <a href="index.html" style="color:var(--accent);text-decoration:none;font-size:14px;">홈으로</a>
  </nav>
</header>
<main>
  <div class="card">
    <div class="toolbar">
      <label class="filelabel" for="fileInput">CSV 업로드</label>
      <input id="fileInput" type="file" accept=".xlsx,.xls,.xlsm,.csv,.tsv,.txt" />
      <select id="sheetSelect" title="시트 선택" disabled></select>
      <button id="downloadAll" class="btn" disabled>CSV 내보내기(전체)</button>
      <button id="downloadFiltered" class="btn secondary" disabled>CSV 내보내기(필터 결과)</button>
      <button id="clearBtn" class="btn ghost" disabled>초기화</button>
      <span class="hint">형식: A열=리뷰아이디, B열=이미지URL (헤더 허용)</span>
    </div>

    <!-- 필터 + 마스터 체크 + 페이지 사이즈 -->
    <div class="filters">
      <input id="searchInput" class="input" placeholder="검색: 리뷰아이디/파일명" />
      <select id="statusFilter" title="상태">
        <option value="all">상태: 전체</option>
        <option value="ok">이미지 로드 성공</option>
        <option value="fail">이미지 로드 실패/URL없음</option>
      </select>
      <select id="hostFilter" title="도메인" disabled>
        <option value="all">도메인: 전체</option>
      </select>
      <label class="small"><input type="checkbox" id="checkedOnly" /> 체크된 항목만</label>

      <div class="master">
        <label class="small"><input type="checkbox" id="masterCheck" /> 현재 페이지 전체 선택</label>
        <button id="uncheckAll" class="btn secondary" type="button">전체 해제</button>
      </div>

      <label class="small" style="display:flex;align-items:center;gap:6px;margin-left:auto">
        페이지당
        <input id="pageSizeInput" type="number" class="input number-input" min="1" value="20" />
        건
      </label>

      <div class="count" id="countInfo">0 / 0</div>
    </div>

    <div id="drop" class="drop small">여기에 파일을 드래그&드롭해도 됩니다.</div>

    <div class="grid-head">
      <div>리뷰아이디</div><div>파일명</div><div>이미지 (150×150)</div><div>체크</div>
    </div>
    <div id="list"></div>
    <div id="empty" class="empty">CSV를 업로드하면 세로 목록으로 표시됩니다.</div>

    <!-- 페이지네이션 -->
    <div class="pagination">
      <button id="firstBtn" class="btn small" disabled>&laquo; 처음</button>
      <button id="prevBtn" class="btn small" disabled>&lsaquo; 이전</button>

      <div id="pageNumbers" class="page-numbers"></div>

      <span class="page-info" id="pageInfo">페이지 0 / 0</span>
      <label class="small" style="display:flex;align-items:center;gap:6px">
        이동
        <input id="pageJump" type="number" class="input number-input" min="1" value="1" />
        페이지
      </label>
      <button id="nextBtn" class="btn small" disabled>다음 &rsaquo;</button>
      <button id="lastBtn" class="btn small" disabled>끝 &raquo;</button>
    </div>
  </div>
</main>

<div class="sticky">
  <button id="downloadAll2" class="btn" disabled>CSV(전체)</button>
  <button id="downloadFiltered2" class="btn secondary" disabled>CSV(필터)</button>
</div>

<script>
const S = {
  fileInput: document.getElementById('fileInput'),
  sheetSelect: document.getElementById('sheetSelect'),
  list: document.getElementById('list'),
  empty: document.getElementById('empty'),
  dlAll: document.getElementById('downloadAll'),
  dlAll2: document.getElementById('downloadAll2'),
  dlFiltered: document.getElementById('downloadFiltered'),
  dlFiltered2: document.getElementById('downloadFiltered2'),
  clear: document.getElementById('clearBtn'),
  drop: document.getElementById('drop'),
  search: document.getElementById('searchInput'),
  status: document.getElementById('statusFilter'),
  host: document.getElementById('hostFilter'),
  checkedOnly: document.getElementById('checkedOnly'),
  count: document.getElementById('countInfo'),
  masterCheck: document.getElementById('masterCheck'),
  uncheckAll: document.getElementById('uncheckAll'),
  pageSizeInput: document.getElementById('pageSizeInput'),
  pageInfo: document.getElementById('pageInfo'),
  pageJump: document.getElementById('pageJump'),
  firstBtn: document.getElementById('firstBtn'),
  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  lastBtn: document.getElementById('lastBtn'),
  pageNumbers: document.getElementById('pageNumbers')
};
let wb = null;        // 전체 워크북(읽기만)
let rows = [];        // 원본 행
let lastFileName = '';

const state = {
  currentPage: 1,
  pageSize: 20
};

function showEmpty(state){ S.empty.style.display = state ? 'block' : 'none'; }
function setControlsEnabled(hasData){
  [S.dlAll,S.dlAll2,S.dlFiltered,S.dlFiltered2,S.clear].forEach(b=> b.disabled = !hasData);
  S.sheetSelect.disabled = !wb;
  S.host.disabled = !hasData || hostSet.size<=1;
  S.masterCheck.disabled = !hasData;
  S.uncheckAll.disabled = !hasData;
  [S.firstBtn,S.prevBtn,S.nextBtn,S.lastBtn,S.pageJump,S.pageSizeInput].forEach(el => el.disabled = !hasData);
}

/* ---------- 유틸 ---------- */
function deriveFilename(url){
  try{
    const u = new URL(url);
    const p = u.pathname.split('/').filter(Boolean);
    if(!p.length) return null;
    return decodeURIComponent(p[p.length-1]);
  }catch{
    if(typeof url==='string'){
      const parts = url.split('?')[0].split('#')[0].split('/');
      return parts.length ? decodeURIComponent(parts[parts.length-1] || '') || null : null;
    }
    return null;
  }
}
function deriveHost(url){ try{ return new URL(url).host || null; }catch{ return null; } }

/* ---------- 파싱 ---------- */
function parseAoA(aoa){
  if(!aoa || !aoa.length) return [];
  const first = aoa[0].map(v=>String(v??'').toLowerCase());
  let start = 0;
  const isHeader = first.some(v => v.includes('리뷰') || v.includes('review')) ||
                   first.some(v => v.includes('이미지') || v.includes('image') || v.includes('url'));
  if(isHeader) start = 1;

  const out = [];
  for(let i=start;i<aoa.length;i++){
    const r = aoa[i] || [];
    const reviewId = (r[0]??'').toString().trim();
    const imageUrlRaw = (r[1]??'').toString().trim();
    if(!reviewId && !imageUrlRaw) continue;
    const imageUrl = imageUrlRaw || null;
    const filename = imageUrl ? deriveFilename(imageUrl) : null;
    const host = imageUrl ? deriveHost(imageUrl) : null;
    // 이미지가 없으면 기본 체크 = true
    const checked = !imageUrl;
    out.push({reviewId, imageUrl, filename, host, checked, loadOK: imageUrl ? undefined : false});
  }
  return out;
}

/* ---------- 필터 ---------- */
let hostSet = new Set(['all']);
function rebuildHostFilter(){
  hostSet = new Set(['all']);
  rows.forEach(r=>{ if(r.host) hostSet.add(r.host); });
  const prev = S.host.value;
  S.host.innerHTML = '';
  for(const h of hostSet){
    const opt = document.createElement('option');
    opt.value = h; opt.textContent = (h==='all'?'도메인: 전체':h);
    S.host.appendChild(opt);
  }
  if(hostSet.has(prev)) S.host.value = prev;
  S.host.disabled = hostSet.size<=1;
}

function applyFilters(){
  const q = S.search.value.trim().toLowerCase();
  const st = S.status.value; // all / ok / fail
  const domain = S.host.value; // all or host
  const onlyChecked = S.checkedOnly.checked;

  let arr = rows.slice();

  if(q){
    arr = arr.filter(r=>{
      const a = (r.reviewId||'').toLowerCase();
      const b = (r.filename||'').toLowerCase();
      return a.includes(q) || b.includes(q);
    });
  }

  if(st === 'ok') arr = arr.filter(r=> r.loadOK === true);
  else if(st === 'fail') arr = arr.filter(r=> r.loadOK === false);

  if(domain && domain !== 'all') arr = arr.filter(r=> (r.host||'') === domain);

  if(onlyChecked) arr = arr.filter(r=> r.checked === true);

  return arr;
}

/* ---------- 렌더 + 페이지네이션 ---------- */
function getPaged(arr){
  const total = arr.length;
  const pages = Math.max(1, Math.ceil(total / Math.max(1, state.pageSize)));
  if(state.currentPage > pages) state.currentPage = pages;
  const start = (state.currentPage - 1) * state.pageSize;
  const subset = arr.slice(start, start + state.pageSize);
  return { subset, total, pages, start };
}

function updatePaginationUI(totalFiltered, pages){
  S.pageInfo.textContent = `페이지 ${state.currentPage} / ${pages}`;
  S.pageJump.min = 1;
  S.pageJump.max = pages;
  S.pageJump.value = state.currentPage;
  S.firstBtn.disabled = state.currentPage<=1;
  S.prevBtn.disabled  = state.currentPage<=1;
  S.nextBtn.disabled  = state.currentPage>=pages;
  S.lastBtn.disabled  = state.currentPage>=pages;
  renderPageButtons(pages);
}

function renderPageButtons(pages){
  // 최대 5개 숫자 버튼
  const maxBtns = 5;
  let start = Math.max(1, state.currentPage - Math.floor(maxBtns/2));
  let end = start + maxBtns - 1;
  if(end > pages){ end = pages; start = Math.max(1, end - maxBtns + 1); }

  S.pageNumbers.innerHTML = '';
  for(let i=start; i<=end; i++){
    const b = document.createElement('button');
    b.className = 'page-btn';
    b.textContent = i;
    if(i === state.currentPage){
      b.classList.add('active');
      b.disabled = true;
      b.setAttribute('aria-current','page');
    }
    b.addEventListener('click', ()=>{
      state.currentPage = i;
      render();
    });
    S.pageNumbers.appendChild(b);
  }
}

function syncMasterCheckbox(subset){
  const allChecked = subset.length>0 && subset.every(r=>r.checked);
  const someChecked = subset.some(r=>r.checked);
  S.masterCheck.checked = allChecked;
  S.masterCheck.indeterminate = !allChecked && someChecked;
}

function render(){
  const filtered = applyFilters();
  const { subset, total, pages } = getPaged(filtered);

  S.list.innerHTML='';
  if(!rows.length){ showEmpty(true); setControlsEnabled(false); S.count.textContent='0 / 0'; updatePaginationUI(0,1); return; }
  showEmpty(false); setControlsEnabled(true);

  subset.forEach(r => S.list.appendChild(rowElement(r)));

  S.count.textContent = `현재 ${subset.length}건 · 필터 ${total} / 전체 ${rows.length}`;
  updatePaginationUI(total, pages);
  syncMasterCheckbox(subset);
}

function rowElement(r){
  const row = document.createElement('div');
  row.className = 'row';

  const c1 = document.createElement('div'); c1.textContent = r.reviewId ?? ''; row.appendChild(c1);

  const c2 = document.createElement('div');
  const fn = document.createElement('div'); fn.className='filename'; fn.textContent = r.filename ?? '';
  const st = document.createElement('div'); st.className='small'; c2.appendChild(fn); c2.appendChild(st);
  row.appendChild(c2);

  const c3 = document.createElement('div');
  const box = document.createElement('div'); box.className='imgbox';
  if(r.imageUrl){
    const img = document.createElement('img');
    img.loading='lazy'; img.decoding='async'; img.src=r.imageUrl; img.width=150; img.height=150;
    img.onload = ()=>{ r.loadOK=true; st.textContent='이미지 로드 성공'; st.classList.remove('bad'); st.classList.add('good'); };
    img.onerror= ()=>{ 
      r.loadOK=false; 
      r.checked = true; // 실패 시 자동 체크
      st.textContent='이미지 로드 실패 (내보내기: null)'; 
      st.classList.remove('good'); st.classList.add('bad'); 
      box.innerHTML='<span class="small">로드 실패</span>'; 
    };
    box.appendChild(img);
  }else{
    r.loadOK=false; 
    r.checked = true; // URL 없음 → 자동 체크
    st.textContent='URL 없음 (내보내기: null)'; 
    st.classList.add('bad'); 
    box.innerHTML='<span class="small">URL 없음</span>';
  }
  c3.appendChild(box);
  row.appendChild(c3);

  const c4 = document.createElement('div');
  const cb = document.createElement('input'); cb.type='checkbox'; cb.checked=!!r.checked; 
  cb.addEventListener('change',()=>{ r.checked=cb.checked; syncMasterCheckbox(getPaged(applyFilters()).subset); });
  c4.appendChild(cb); row.appendChild(c4);

  return row;
}

/* ---------- 전체 선택/해제 ---------- */
function setCheckedFor(arr, val){
  arr.forEach(r=> r.checked = !!val);
  render();
}
document.getElementById('masterCheck')?.addEventListener('change', ()=>{
  const paged = getPaged(applyFilters());
  setCheckedFor(paged.subset, S.masterCheck.checked); // 현재 페이지 항목만
});
document.getElementById('uncheckAll')?.addEventListener('click', ()=>{
  setCheckedFor(rows, false); // 전체 해제
  S.masterCheck.checked = false;
  S.masterCheck.indeterminate = false;
});

/* ---------- CSV 내보내기(항상 CSV) ---------- */
function saveCSV(arr, filenameTag){
  const out = [['리뷰아이디','파일명','이미지','체크']];
  arr.forEach(r=>{
    const imgCell = (r.loadOK===false) ? null : (r.imageUrl || null);
    const chk = r.checked ? 'x' : '';
    out.push([r.reviewId || '', r.filename || null, imgCell, chk]);
  });
  const csv = out.map(row=>row.map(v=>{
    if(v===null || v===undefined) return '';
    const s = String(v).replace(/"/g,'""');
    return /[",\n]/.test(s) ? `"${s}"` : s;
  }).join(',')).join('\n');

  const blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const t = new Date();
  const tag = `${t.getFullYear()}${String(t.getMonth()+1).padStart(2,'0')}${String(t.getDate()).padStart(2,'0')}_${String(t.getHours()).padStart(2,'0')}${String(t.getMinutes()).padStart(2,'0')}${String(t.getSeconds()).padStart(2,'0')}`;
  a.download = `${(lastFileName||'review')}_${filenameTag}_${tag}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
}

/* ---------- 워크북/파일 로드 ---------- */
function handleWorkbookLoaded(){
  S.sheetSelect.innerHTML='';
  wb.SheetNames.forEach((n,i)=>{
    const opt = document.createElement('option');
    opt.value = n; opt.textContent = `${i+1}. ${n}`;
    S.sheetSelect.appendChild(opt);
  });
  S.sheetSelect.disabled = false;
  loadSheet(wb.SheetNames[0]);
}

function loadSheet(name){
  try{
    const ws = wb.Sheets[name];
    const aoa = XLSX.utils.sheet_to_json(ws, {header:1, raw:true, defval:''});
    rows = parseAoA(aoa);
    rebuildHostFilter();
    if(!rows.length) console.warn(`선택한 시트 "${name}"에서 데이터가 비어있습니다.`);
    state.currentPage = 1; // 새 시트면 1페이지로
    render();
  }catch(e){
    console.warn(`시트 "${name}" 파싱 중 오류`, e);
    rows = []; rebuildHostFilter(); render();
  }
}

function tryReadAsExcelOrCsv(file, buf){
  // 1) XLSX 시도 (읽기만)
  try{
    if(!window.XLSX) throw new Error('XLSX 라이브러리가 로드되지 않았습니다(CDN 차단/로컬 파일 부재 가능).');
    wb = XLSX.read(buf, {type:'array'});
    handleWorkbookLoaded();
    return;
  }catch(e){
    console.warn('XLSX 파싱 실패 → CSV/TSV 백업 파서로 시도', e);
  }

  // 2) CSV/TSV 간단 파서
  const text = new TextDecoder('utf-8').decode(buf);
  const sep = text.includes('\t') ? '\t' : ',';
  const lines = text.split(/\r?\n/).filter(l=>l.trim().length);
  const aoa = lines.map(line=>{
    return line.split(sep).map(cell=>{
      let c = cell.trim();
      if((c.startsWith('"') && c.endsWith('"')) || (c.startsWith("'") && c.endsWith("'"))) c = c.slice(1,-1);
      return c;
    });
  });
  rows = parseAoA(aoa);
  wb = null;
  S.sheetSelect.innerHTML=''; S.sheetSelect.disabled=true;
  rebuildHostFilter();
  state.currentPage = 1;
  render();
}

function onFile(file){
  lastFileName = (file?.name || '').replace(/\.(xlsx|xls|xlsm|csv|tsv|txt)$/i,'');
  const r = new FileReader();
  r.onload = (ev)=>{
    const buf = new Uint8Array(ev.target.result);
    tryReadAsExcelOrCsv(file, buf);
  };
  r.onerror = (e)=> console.error('파일 읽기 실패', e);
  r.readAsArrayBuffer(file);
}

/* ---------- 이벤트 ---------- */
S.fileInput.addEventListener('change', e=>{
  const f = e.target.files?.[0];
  if(!f) return;
  onFile(f);
});

S.drop.addEventListener('dragover', e=>{e.preventDefault(); S.drop.classList.add('drag');});
S.drop.addEventListener('dragleave', ()=>S.drop.classList.remove('drag'));
S.drop.addEventListener('drop', e=>{
  e.preventDefault(); S.drop.classList.remove('drag');
  const f = e.dataTransfer.files?.[0]; if(!f) return; onFile(f);
});

S.sheetSelect.addEventListener('change', e=> loadSheet(e.target.value));

// 필터가 바뀌면 1페이지부터
[S.search, S.status, S.host, S.checkedOnly].forEach(el=> el.addEventListener('input', ()=>{ state.currentPage=1; render(); }));

// 페이지 사이즈 변경
S.pageSizeInput.addEventListener('change', ()=>{
  const v = parseInt(S.pageSizeInput.value, 10);
  state.pageSize = Math.max(1, isNaN(v)? 20 : v);
  state.currentPage = 1;
  render();
});

// 페이지 이동
S.firstBtn.addEventListener('click', ()=>{ state.currentPage=1; render(); });
S.prevBtn.addEventListener('click', ()=>{ state.currentPage=Math.max(1, state.currentPage-1); render(); });
S.nextBtn.addEventListener('click', ()=>{
  const pages = Math.max(1, Math.ceil(applyFilters().length / Math.max(1, state.pageSize)));
  state.currentPage = Math.min(pages, state.currentPage+1); render();
});
S.lastBtn.addEventListener('click', ()=>{
  const pages = Math.max(1, Math.ceil(applyFilters().length / Math.max(1, state.pageSize)));
  state.currentPage = pages; render();
});
S.pageJump.addEventListener('change', ()=>{
  const pages = Math.max(1, Math.ceil(applyFilters().length / Math.max(1, state.pageSize)));
  let v = parseInt(S.pageJump.value,10);
  if(isNaN(v)) v = state.currentPage;
  v = Math.min(Math.max(1,v), pages);
  state.currentPage = v; render();
});

// CSV 저장
S.dlAll.addEventListener('click', ()=> saveCSV(rows, 'all'));
S.dlAll2.addEventListener('click', ()=> saveCSV(rows, 'all'));
S.dlFiltered.addEventListener('click', ()=> saveCSV(applyFilters(), 'filtered'));
S.dlFiltered2.addEventListener('click', ()=> saveCSV(applyFilters(), 'filtered'));

// 초기 상태
showEmpty(true); setControlsEnabled(false);
</script>
</body>
</html>
